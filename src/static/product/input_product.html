{% include 'parts/header.html' %}
{% include 'parts/sidebar.html' %}

<main id="main" class="main">

    <section class="section">
      <div class="form-group">

        <div class="col-lg-12">

          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Input Barang</h5>

              <!-- Form Input Barang -->
              <form class="row g-3" action="{{url_for('insert_item')}}" method="POST">
                <label for="namaproduk" class="form-label">Nama Produk</label>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" name="product_name" id="product_name" value="" aria-describedby="button-addon2"/>
                  <button type="button" class="btn btn-outline-primary" type="button" id="product-btn" data-mdb-ripple-color="dark">
                    <i class="bi bi-camera"></i>
                  </button>
                </div>

                <label for="expired" class="form-label">Expired</label>
                <div class="input-group mb-3">
                  <input type="text" class="form-control" name="expired" id="expired" value="" aria-describedby="button-addon2"/>
                  <button type="button" class="btn btn-outline-primary" type="button" id="expired-btn" data-mdb-ripple-color="dark">
                    <i class="bi bi-camera"></i>
                  </button>
                </div>

                <div class="col-12">
                  <label for="stock" class="form-label">Stock</label>
                  <input type="number" class="form-control" name="stock" id="stock" value="">
                </div>
                <div class="text-center">
                  <button type="submit" class="btn btn-primary">Submit</button>
                </div>
              </form><!-- End Form -->

            </div>
          </div>

        </div>
      </div>
    </section>
    <div id="modal-product" class="modal">

      <!-- Modal content -->
      <div class="modal-content">
      <span class="close">&times;</span>
      <img id="video-stream-product" >
      <br>
      <img id="result-product">
      <br>
      <button onclick="saveProduct()">Capture Image</button>
      <button id="crop-btn-product" style="display: none;" type="button">Crop</button>
      <br>
      </div>
  
  </div>
  <div id="modal-expired" class="modal">

      <!-- Modal content -->
      <div class="modal-content">
      <span class="close">&times;</span>
      <img id="video-stream-expired">
      <br>
      <img id="result-expired">
      <br>
      <button onclick="saveExpired()">Capture Image</button>
      <button id="crop-btn-expired" style="display: none;" type="button">Crop</button>
      <br>
      </div>
  
  </div>


  </main><!-- End #main -->
  <script>
        var modalProduct = document.getElementById("modal-product");
        var modalExpired = document.getElementById("modal-expired");
        var productBtn = document.getElementById("product-btn");
        var expiredBtn = document.getElementById("expired-btn");
        var span = document.getElementsByClassName("close")[0];
        var crop_btn = document.getElementById('crop-btn');

        productBtn.onclick = function() {
            modalProduct.style.display = "block";
            document.getElementById("video-stream-product").src = "{{ url_for('camera_feed') }}";
        }
        expiredBtn.onclick = function() {
            modalExpired.style.display = "block";
            document.getElementById("video-stream-expired").src = "{{ url_for('camera_feed') }}";
        }
        window.onclick = function(event){
            if (event.target == modalProduct) {
                modalProduct.style.display = "none";
            }
            if (event.target == modalExpired) {
                modalExpired.style.display = "none";
            }
        }

        function saveProduct(){
            saveImageAndSend("video-stream-product","result-product","product_name","crop-btn-product")
        }
        function saveExpired(){
            saveImageAndSend("video-stream-expired","result-expired","expired","crop-btn-expired")
        }
        function saveImageAndSend(img_param,result_param,input_name,crop_param) {
        var img = document.getElementsByTagName('img')[0];
        var canvas = document.createElement('canvas');
        var img = document.getElementById(img_param);
        const crop_btn = document.getElementById(crop_param)
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        var resultImg = document.getElementById(result_param);
        var image = canvas.toDataURL();
        resultImg.src =image;
        const cropper = new Cropper(resultImg, {
          autoCropArea: 1,
          viewMode: 1,
          scalable: false,
          zoomable: false,
          movable: false,
          minCropBoxWidth: 20,
          minCropBoxHeight: 20,
          background:false,
        });
        document.getElementById(crop_param).style.display = 'block';
        img.src = "";
        crop_btn.addEventListener('click',()=>{
            cropper.getCroppedCanvas().toBlob((blob)=>{
              var formData = new FormData();
              formData.append('image', blob, 'image.png');
              fetch('/product/capture', {
                method: 'POST',
                body: formData
              })
              .then(function(response) {
                response.text().then(function(data) {
                    console.log(data);
                    // document.getElementById('message').innerHTML = JSON.parse(data).message;
                    document.getElementById(input_name).value = JSON.parse(data).message;
                  });
              })
              .catch(function(error) {
                console.error('Error uploading image:', error);
              });
            },'image/png');
            cropper.destroy(); // Destroy the cropper instance
            crop_btn.style.display = 'none'; // Hide the crop button
            resultImg.src = "";
            modalExpired.style.display = "none";
            modalProduct.style.display = "none";
          });
      }
	</script>
  
  {% include 'parts/footer.html' %}